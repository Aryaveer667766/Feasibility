<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Freelancer Dashboard - Sahil Sharma</title>
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Lucide Icons -->
    <script src="https://unpkg.com/lucide@latest"></script>
    <!-- Google Fonts: Inter -->
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <!-- Toastify for notifications -->
    <link rel="stylesheet" type="text/css" href="https://cdn.jsdelivr.net/npm/toastify-js/src/toastify.min.css">
    <script type="text/javascript" src="https://cdn.jsdelivr.net/npm/toastify-js"></script>
    
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    fontFamily: {
                        sans: ['Inter', 'sans-serif'],
                    },
                    colors: {
                        slate: {
                            850: '#151e2e', // Custom dark shade
                            900: '#0f172a',
                        }
                    },
                    animation: {
                        'glow-pulse': 'glowPulse 2s cubic-bezier(0.4, 0, 0.6, 1) infinite',
                        'fade-in': 'fadeIn 0.3s ease-out',
                        'slide-in': 'slideIn 0.3s ease-out',
                    },
                    keyframes: {
                        glowPulse: {
                            '0%, 100%': { boxShadow: '0 0 5px #fbbf24, 0 0 10px #fbbf24' }, // Amber glow
                            '50%': { boxShadow: '0 0 2px #fbbf24, 0 0 5px #fbbf24' },
                        },
                        fadeIn: {
                            '0%': { opacity: '0', transform: 'translateY(10px)' },
                            '100%': { opacity: '1', transform: 'translateY(0)' },
                        },
                        slideIn: {
                            '0%': { transform: 'translateX(-100%)' },
                            '100%': { transform: 'translateX(0)' },
                        }
                    }
                }
            }
        }
    </script>
    <style>
        body {
            font-family: 'Inter', sans-serif;
            background-color: #0f172a;
        }
        .glass-panel {
            background: rgba(30, 41, 59, 0.7);
            backdrop-filter: blur(12px);
            -webkit-backdrop-filter: blur(12px);
            border: 1px solid rgba(255, 255, 255, 0.05);
        }
        .glass-modal {
            /* Full dark background for better focus, especially the admin panel */
            background: rgba(15, 23, 42, 0.98); 
            backdrop-filter: blur(16px);
            max-height: 95vh;
            overflow-y: auto; /* Ensure scrollable on mobile */
        }
        /* Custom Scrollbar */
        ::-webkit-scrollbar {
            width: 8px;
        }
        ::-webkit-scrollbar-track {
            background: #0f172a; 
        }
        ::-webkit-scrollbar-thumb {
            background: #334155; 
            border-radius: 4px;
        }
        ::-webkit-scrollbar-thumb:hover {
            background: #475569; 
        }
    </style>
</head>
<body class="text-gray-300 antialiased min-h-screen flex overflow-hidden">

    <!-- Sidebar Navigation (Desktop) -->
    <aside class="w-20 lg:w-72 bg-slate-900 border-r border-slate-800 flex flex-col hidden md:flex transition-all duration-300">
        <div class="h-16 flex items-center justify-center lg:justify-start lg:px-6 border-b border-slate-800 shrink-0">
            <div class="w-8 h-8 bg-blue-600 rounded-lg flex items-center justify-center mr-0 lg:mr-3">
                <i data-lucide="briefcase" class="text-white w-5 h-5"></i>
            </div>
            <span class="text-white font-bold text-xl hidden lg:block">WorkSphere</span>
        </div>
        
        <nav class="flex-1 py-6 space-y-2 px-3 overflow-y-auto">
            <button onclick="switchTab('dashboard')" id="nav-dashboard" class="w-full flex items-center px-3 py-3 bg-blue-600/10 text-blue-400 rounded-lg group transition-all">
                <i data-lucide="layout-dashboard" class="w-5 h-5 mr-3"></i>
                <span class="hidden lg:block font-medium">Dashboard</span>
            </button>
            <button onclick="switchTab('browse')" id="nav-browse" class="w-full flex items-center px-3 py-3 text-gray-400 hover:bg-slate-800 hover:text-white rounded-lg transition-all group">
                <i data-lucide="search" class="w-5 h-5 mr-3"></i>
                <span class="hidden lg:block font-medium">Browse Projects</span>
            </button>
            <button onclick="switchTab('messages')" id="nav-messages" class="w-full flex items-center px-3 py-3 text-gray-400 hover:bg-slate-800 hover:text-white rounded-lg transition-all group">
                <i data-lucide="message-square" class="w-5 h-5 mr-3"></i>
                <span class="hidden lg:block font-medium">Messages</span>
                <span class="hidden lg:flex ml-auto bg-red-500 text-white text-xs font-bold px-2 py-0.5 rounded-full">3</span>
            </button>
            <button onclick="switchTab('finances')" id="nav-finances" class="w-full flex items-center px-3 py-3 text-gray-400 hover:bg-slate-800 hover:text-white rounded-lg transition-all group">
                <i data-lucide="credit-card" class="w-5 h-5 mr-3"></i>
                <span class="hidden lg:block font-medium">Finances</span>
            </button>
        </nav>

        <!-- Wallet Widget (Desktop Sidebar) -->
        <div class="px-4 pb-4 hidden lg:block">
            <div class="bg-gradient-to-br from-slate-800 to-slate-900 border border-slate-700 p-4 rounded-xl shadow-lg relative overflow-hidden group">
                <div class="absolute top-0 right-0 w-16 h-16 bg-emerald-500/10 rounded-full blur-xl -mr-4 -mt-4"></div>
                
                <div class="flex justify-between items-start mb-2">
                    <p class="text-xs text-gray-400 font-semibold uppercase tracking-wider">Wallet Balance</p>
                    <i data-lucide="wallet" class="w-4 h-4 text-emerald-400"></i>
                </div>
                <p class="text-2xl font-bold text-white tracking-tight">$ <span id="sidebar-wallet-amount">0</span></p>
                
                <button onclick="addFunds()" class="mt-3 w-full py-2 bg-emerald-600 hover:bg-emerald-500 text-white text-xs font-bold rounded-lg transition-colors flex items-center justify-center gap-2">
                    <i data-lucide="plus" class="w-3 h-3"></i> Add Funds
                </button>
            </div>
        </div>

        <div class="p-4 border-t border-slate-800 shrink-0">
            <div class="flex items-center">
                <img src="https://ui-avatars.com/api/?name=Sahil+Sharma&background=3b82f6&color=fff" alt="User" class="w-10 h-10 rounded-full border-2 border-slate-700">
                <div class="ml-3 hidden lg:block">
                    <p class="text-sm font-medium text-white">Sahil Sharma</p>
                    <p class="text-xs text-gray-500">Junior Associate</p>
                </div>
            </div>
        </div>
    </aside>

    <!-- Main Content -->
    <main class="flex-1 flex flex-col relative overflow-y-auto h-screen bg-slate-900" id="main-container">
        
        <!-- Mobile Header -->
        <header class="h-16 bg-slate-900/80 backdrop-blur-md border-b border-slate-800 flex items-center justify-between px-4 sticky top-0 z-20 md:hidden">
            <div class="flex items-center gap-4">
                <!-- Mobile Menu Button -->
                <button onclick="toggleMobileMenu()" class="text-gray-400 hover:text-white p-1">
                    <i data-lucide="menu" class="w-6 h-6"></i>
                </button>
                <span class="text-white font-bold text-lg">WorkSphere</span>
            </div>
            <div class="flex items-center gap-3">
                <!-- Small Wallet in Header -->
                 <div class="bg-slate-800 px-2 py-1 rounded text-xs font-mono text-emerald-400 border border-slate-700 hidden sm:block">
                    $<span id="header-wallet-amount">0</span>
                </div>
                <img src="https://ui-avatars.com/api/?name=Sahil+Sharma&background=3b82f6&color=fff" alt="User" class="w-8 h-8 rounded-full border border-slate-600">
            </div>
        </header>

        <!-- DASHBOARD VIEW -->
        <div id="view-dashboard" class="p-4 lg:p-10 max-w-7xl mx-auto w-full animate-fade-in pb-24">
            
            <!-- Greeting Section -->
            <div class="mb-8">
                <h1 class="text-3xl lg:text-4xl font-bold text-white tracking-tight">
                    <span id="greeting-text">Hello</span>, Sahil Sharma.
                </h1>
                <p class="text-gray-400 mt-2">Here is the status of your active bids.</p>
            </div>

            <!-- Placeholder when no project is assigned -->
            <div id="no-project-placeholder" class="glass-panel rounded-2xl p-10 text-center border-blue-500/30">
                <i data-lucide="folder-x" class="w-12 h-12 mx-auto text-blue-400 mb-4"></i>
                <h2 class="text-2xl font-bold text-white mb-2">No Active Project Assigned</h2>
                <p class="text-gray-400">The dashboard is currently clear. A project must be assigned by your administrator.</p>
            </div>

            <!-- Active Bids Section -->
            <div id="active-bids-section" class="grid grid-cols-1 gap-6 hidden">
                
                <!-- The Specific Project Card -->
                <div id="project-card" class="glass-panel rounded-2xl p-1 border border-blue-500/30 relative overflow-hidden transition-all duration-300">
                    <!-- Glow Background -->
                    <div class="absolute top-0 right-0 -mr-16 -mt-16 w-64 h-64 rounded-full bg-blue-500/10 blur-3xl"></div>

                    <div class="bg-slate-850/90 rounded-xl p-6 lg:p-8 h-full relative z-10">
                        
                        <!-- Card Header -->
                        <div class="flex flex-col md:flex-row justify-between items-start md:items-center mb-6 gap-4">
                            <div class="flex items-start space-x-4">
                                <div class="bg-indigo-500/20 p-3 rounded-lg border border-indigo-500/30 text-indigo-400 shrink-0">
                                    <i data-lucide="pen-tool" class="w-6 h-6"></i>
                                </div>
                                <div>
                                    <div class="flex items-center gap-3">
                                        <!-- Project Name Display -->
                                        <h2 id="project-name-display" class="text-xl lg:text-2xl font-semibold text-white truncate max-w-xs sm:max-w-none">Loading Project...</h2>
                                        <!-- NEW: Top Match Badge -->
                                        <span class="bg-gradient-to-r from-emerald-500 to-teal-500 text-white text-xs font-bold px-2 py-1 rounded-full shadow-lg shadow-emerald-500/20 flex items-center">
                                            <i data-lucide="sparkles" class="w-3 h-3 mr-1"></i> Top Match
                                        </span>
                                    </div>
                                    <div class="flex flex-wrap items-center gap-2 mt-2 text-sm">
                                        <span class="bg-slate-700 text-slate-300 px-2 py-0.5 rounded border border-slate-600">Graphic Design</span>
                                        <span class="bg-slate-700 text-slate-300 px-2 py-0.5 rounded border border-slate-600">Branding</span>
                                        <span class="text-gray-500 flex items-center"><i data-lucide="map-pin" class="w-3 h-3 mr-1"></i> Remote</span>
                                    </div>
                                </div>
                            </div>

                            <!-- Live Timer -->
                            <div class="md:ml-auto relative shrink-0 w-full md:w-auto">
                                <div id="timer-container" class="flex items-center justify-center md:inline-flex px-4 py-2 rounded-full bg-amber-500/10 border border-amber-500/50 text-amber-400 font-mono font-medium text-sm animate-glow-pulse transition-all duration-300 w-full md:w-auto">
                                    <i data-lucide="clock" class="w-4 h-4 mr-2 animate-pulse"></i>
                                    <span id="countdown">Loading...</span>
                                </div>
                                <!-- NEW: Client Activity Indicator -->
                                <div class="absolute -bottom-6 right-0 text-xs text-emerald-400 font-medium flex items-center justify-end w-full mt-1">
                                    <span class="relative flex h-2 w-2 mr-2">
                                      <span class="animate-ping absolute inline-flex h-full w-full rounded-full bg-emerald-400 opacity-75"></span>
                                      <span class="relative inline-flex rounded-full h-2 w-2 bg-emerald-500"></span>
                                    </span>
                                    Client viewed 12m ago
                                </div>
                            </div>
                        </div>

                        <!-- NEW: AI Insights & Reaction Grid -->
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-6">
                            <!-- Existing Client Reaction -->
                            <div class="bg-gradient-to-r from-blue-600/10 to-transparent border-l-4 border-blue-500 p-4 rounded-r-lg flex items-center group hover:bg-blue-600/20 transition-colors cursor-default">
                                <div class="bg-blue-500 rounded-full p-1.5 mr-3 shrink-0 shadow-lg shadow-blue-500/30 group-hover:scale-110 transition-transform">
                                    <i data-lucide="thumbs-up" class="w-4 h-4 text-white fill-white"></i>
                                </div>
                                <div>
                                    <p class="text-sm font-semibold text-white">Client Reaction</p>
                                    <p class="text-xs text-blue-200">Owner liked your proposal.</p>
                                </div>
                            </div>

                            <!-- NEW: AI Competitive Analysis -->
                            <div class="bg-gradient-to-r from-emerald-600/10 to-transparent border-l-4 border-emerald-500 p-4 rounded-r-lg flex items-center group hover:bg-emerald-600/20 transition-colors cursor-default">
                                <div class="bg-emerald-500 rounded-full p-1.5 mr-3 shrink-0 shadow-lg shadow-emerald-500/30 group-hover:scale-110 transition-transform">
                                    <i data-lucide="trending-up" class="w-4 h-4 text-white"></i>
                                </div>
                                <div>
                                    <p class="text-sm font-semibold text-white">High Win Probability</p>
                                    <p class="text-xs text-emerald-200">Your bid is <span class="font-bold">15% more competitive</span> than average.</p>
                                </div>
                            </div>
                        </div>

                        <hr class="border-slate-700/50 mb-6">

                        <!-- Bid Details -->
                        <div class="grid grid-cols-1 md:grid-cols-3 gap-6 lg:gap-8">
                            
                            <!-- Price Display (Bid Amount) -->
                            <div class="col-span-1 bg-slate-800/50 p-5 rounded-xl border border-slate-700/50 flex flex-col justify-center hover:bg-slate-800/70 transition-colors text-center md:text-left">
                                <p class="text-sm text-gray-400 font-medium mb-1">Your Proposed Price</p>
                                <div class="flex items-baseline justify-center md:justify-start text-emerald-400">
                                    <span class="text-2xl font-medium mr-1">$</span>
                                    <span id="display-price" class="text-5xl font-bold tracking-tight">N/A</span>
                                    <span class="text-lg text-gray-500 ml-2">USD</span>
                                </div>
                                <p class="text-xs text-gray-500 mt-2">For full project completion</p>
                            </div>

                            <!-- Project Stats -->
                            <div class="col-span-1 md:col-span-2 grid grid-cols-2 gap-4">
                                <div class="space-y-4">
                                    <div>
                                        <p class="text-xs text-gray-500 uppercase tracking-wider font-semibold">Client Rating</p>
                                        <div class="flex items-center mt-1">
                                            <i data-lucide="star" class="w-4 h-4 text-yellow-400 fill-yellow-400"></i>
                                            <i data-lucide="star" class="w-4 h-4 text-yellow-400 fill-yellow-400 ml-1"></i>
                                            <i data-lucide="star" class="w-4 h-4 text-yellow-400 fill-yellow-400 ml-1"></i>
                                            <i data-lucide="star" class="w-4 h-4 text-yellow-400 fill-yellow-400 ml-1"></i>
                                            <i data-lucide="star" class="w-4 h-4 text-yellow-400 fill-yellow-400 ml-1"></i>
                                            <span class="text-white ml-2 font-medium">5.0</span>
                                        </div>
                                    </div>
                                    <div>
                                        <p class="text-xs text-gray-500 uppercase tracking-wider font-semibold">Delivery Time</p>
                                        <p class="text-white mt-1 font-medium" id="display-delivery-time">2 Days</p>
                                    </div>
                                </div>
                                <div class="space-y-4">
                                    <div>
                                        <p class="text-xs text-gray-500 uppercase tracking-wider font-semibold">Proposal Status</p>
                                        <div class="flex items-center mt-1" id="status-container">
                                            <!-- Status injected via JS -->
                                        </div>
                                    </div>
                                    <div>
                                        <p class="text-xs text-gray-500 uppercase tracking-wider font-semibold">Proposal ID</p>
                                        <p class="text-white mt-1 font-mono text-sm" id="display-proposal-id">Loading...</p>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Action Buttons -->
                        <div class="mt-8 flex flex-col sm:flex-row gap-4" id="action-buttons">
                            <button onclick="openEditModal()" class="w-full sm:w-auto px-6 py-2.5 bg-blue-600 hover:bg-blue-500 text-white font-medium rounded-lg transition-colors shadow-lg shadow-blue-600/20 flex items-center justify-center gap-2">
                                <i data-lucide="edit-3" class="w-4 h-4"></i> Edit Proposal
                            </button>
                            <button onclick="withdrawBid()" class="w-full sm:w-auto px-6 py-2.5 bg-transparent border border-slate-600 text-gray-300 hover:text-white hover:border-red-500 hover:text-red-400 hover:bg-red-500/10 font-medium rounded-lg transition-all flex items-center justify-center gap-2">
                                <i data-lucide="x-circle" class="w-4 h-4"></i> Withdraw Bid
                            </button>
                        </div>
                        
                        <!-- Withdrawn Message (Hidden by default) -->
                        <div id="withdrawn-msg" class="mt-8 hidden">
                            <div class="bg-red-500/10 border border-red-500/20 text-red-200 px-4 py-3 rounded-lg flex items-center w-full">
                                <i data-lucide="alert-circle" class="w-5 h-5 mr-2 text-red-500 flex-shrink-0"></i>
                                <span class="text-sm">You have withdrawn this proposal. You can no longer edit it.</span>
                            </div>
                        </div>

                    </div>
                </div>

                <!-- Scope of Work Description (The Full Description) -->
                <div class="glass-panel rounded-2xl p-6 lg:p-8">
                    <h3 class="text-2xl font-bold text-white mb-4 border-b border-slate-700 pb-2">Full Scope of Work</h3>
                    <div id="project-description" class="bg-slate-800/50 p-4 rounded-xl text-slate-300 text-base h-72 overflow-y-auto scrollable-content leading-relaxed">
                        Awaiting detailed project brief from the Configuration Panel...
                    </div>
                </div>

            </div>
        </div>

        <!-- PLACEHOLDER VIEW (Other Tabs) -->
        <div id="view-placeholder" class="hidden flex-1 flex flex-col items-center justify-center p-10 text-center animate-fade-in">
            <div class="bg-slate-800/50 p-8 rounded-full mb-6 border border-slate-700">
                <i id="placeholder-icon" data-lucide="hammer" class="w-12 h-12 text-gray-500"></i>
            </div>
            <h2 id="placeholder-title" class="text-2xl font-bold text-white mb-2">Section Title</h2>
            <p class="text-gray-400 max-w-md">Access to this module is currently restricted for new accounts. Please complete your onboarding checklist to unlock full system access.</p>
            <button onclick="switchTab('dashboard')" class="mt-8 px-6 py-2 bg-slate-800 hover:bg-slate-700 border border-slate-700 text-white rounded-lg transition-colors">
                Return to Dashboard
            </button>
        </div>

    </main>

    <!-- MOBILE NAVIGATION DRAWER -->
    <div id="mobile-menu" class="fixed inset-0 z-50 hidden" aria-hidden="true">
        <!-- Backdrop -->
        <div class="absolute inset-0 bg-slate-900/80 backdrop-blur-sm transition-opacity" onclick="toggleMobileMenu()"></div>
        
        <!-- Drawer Panel -->
        <div class="absolute left-0 top-0 bottom-0 w-72 bg-slate-900 border-r border-slate-800 p-4 transform transition-transform duration-300 animate-slide-in flex flex-col">
             <!-- Header -->
             <div class="flex justify-between items-center mb-8 border-b border-slate-800 pb-4">
                 <div class="flex items-center gap-3">
                    <div class="w-8 h-8 bg-blue-600 rounded-lg flex items-center justify-center">
                        <i data-lucide="briefcase" class="text-white w-5 h-5"></i>
                    </div>
                    <span class="text-white font-bold text-xl">WorkSphere</span>
                 </div>
                 <button onclick="toggleMobileMenu()" class="text-gray-400 hover:text-white">
                     <i data-lucide="x" class="w-6 h-6"></i>
                 </button>
             </div>

             <!-- User Info Mobile -->
            <div class="flex items-center mb-8 px-2">
                <img src="https://ui-avatars.com/api/?name=Sahil+Sharma&background=3b82f6&color=fff" alt="User" class="w-10 h-10 rounded-full border-2 border-slate-700">
                <div class="ml-3">
                    <p class="text-sm font-medium text-white">Sahil Sharma</p>
                    <p class="text-xs text-gray-500">Junior Associate</p>
                </div>
            </div>

             <!-- Nav Links -->
             <nav class="flex-1 space-y-2">
                <button onclick="switchTab('dashboard'); toggleMobileMenu()" id="mobile-nav-dashboard" class="w-full flex items-center px-3 py-3 bg-blue-600/10 text-blue-400 rounded-lg transition-all">
                    <i data-lucide="layout-dashboard" class="w-5 h-5 mr-3"></i>
                    <span class="font-medium">Dashboard</span>
                </button>
                <button onclick="switchTab('browse'); toggleMobileMenu()" id="mobile-nav-browse" class="w-full flex items-center px-3 py-3 text-gray-400 hover:bg-slate-800 hover:text-white rounded-lg transition-all">
                    <i data-lucide="search" class="w-5 h-5 mr-3"></i>
                    <span class="font-medium">Browse Projects</span>
                </button>
                <button onclick="switchTab('messages'); toggleMobileMenu()" id="mobile-nav-messages" class="w-full flex items-center px-3 py-3 text-gray-400 hover:bg-slate-800 hover:text-white rounded-lg transition-all">
                    <i data-lucide="message-square" class="w-5 h-5 mr-3"></i>
                    <span class="font-medium">Messages</span>
                </button>
                <button onclick="switchTab('finances'); toggleMobileMenu()" id="mobile-nav-finances" class="w-full flex items-center px-3 py-3 text-gray-400 hover:bg-slate-800 hover:text-white rounded-lg transition-all">
                    <i data-lucide="credit-card" class="w-5 h-5 mr-3"></i>
                    <span class="font-medium">Finances</span>
                </button>
            </nav>

            <!-- Wallet Widget Mobile -->
            <div class="mt-auto pt-6 border-t border-slate-800">
                <div class="bg-gradient-to-br from-slate-800 to-slate-900 border border-slate-700 p-4 rounded-xl shadow-lg">
                    <div class="flex justify-between items-start mb-2">
                        <p class="text-xs text-gray-400 font-semibold uppercase tracking-wider">Wallet Balance</p>
                        <i data-lucide="wallet" class="w-4 h-4 text-emerald-400"></i>
                    </div>
                    <p class="text-2xl font-bold text-white tracking-tight">$ <span id="drawer-wallet-amount">0</span></p>
                    <button onclick="addFunds()" class="mt-3 w-full py-2 bg-emerald-600 hover:bg-emerald-500 text-white text-xs font-bold rounded-lg transition-colors flex items-center justify-center gap-2">
                        <i data-lucide="plus" class="w-3 h-3"></i> Add Funds
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- EDIT PROPOSAL MODAL -->
    <div id="edit-modal" class="fixed inset-0 z-50 hidden items-center justify-center p-4">
        <!-- Backdrop -->
        <div class="absolute inset-0 bg-slate-900/80 backdrop-blur-sm transition-opacity" onclick="closeEditModal()"></div>
        
        <!-- Modal Content -->
        <div class="glass-modal relative w-full max-w-md rounded-2xl border border-slate-700 shadow-2xl p-6 transform transition-all scale-100">
            <div class="flex justify-between items-center mb-6">
                <h3 class="text-xl font-bold text-white">Edit Proposal</h3>
                <button onclick="closeEditModal()" class="text-gray-400 hover:text-white">
                    <i data-lucide="x" class="w-5 h-5"></i>
                </button>
            </div>

            <div class="space-y-4">
                <div>
                    <label class="block text-sm font-medium text-gray-400 mb-1">Bid Amount (USD)</label>
                    <div class="relative">
                        <span class="absolute left-3 top-1/2 -translate-y-1/2 text-gray-500">$</span>
                        <input type="number" id="edit-price-input" class="w-full bg-slate-800 border border-slate-700 rounded-lg py-2.5 pl-8 pr-4 text-white focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-transparent placeholder-gray-600" placeholder="0.00">
                    </div>
                    <p class="text-xs text-gray-500 mt-1">Includes Freelancer fee.</p>
                </div>
                
                <div>
                    <label class="block text-sm font-medium text-gray-400 mb-1">Delivery Time</label>
                    <select id="edit-delivery-time" class="w-full bg-slate-800 border border-slate-700 rounded-lg py-2.5 px-3 text-white focus:outline-none focus:ring-2 focus:ring-blue-500">
                        <option>1 Day</option>
                        <option>2 Days</option>
                        <option>3 Days</option>
                        <option>7 Days</option>
                        <option>14 Days</option>
                        <option>30 Days</option>
                    </select>
                </div>
            </div>

            <div class="flex gap-3 mt-8">
                <button onclick="closeEditModal()" class="flex-1 py-2.5 bg-slate-800 hover:bg-slate-700 text-gray-300 font-medium rounded-lg transition-colors">
                    Cancel
                </button>
                <button onclick="saveProposal()" class="flex-1 py-2.5 bg-blue-600 hover:bg-blue-500 text-white font-medium rounded-lg transition-colors shadow-lg shadow-blue-600/20">
                    Save Changes
                </button>
            </div>
        </div>
    </div>

    <!-- Configuration Panel (Hidden - Accessed via Ctrl+Alt+U) -->
    <div id="admin-panel" class="fixed inset-0 z-50 hidden items-center justify-center p-4">
        <!-- Backdrop -->
        <div class="absolute inset-0 bg-slate-900/80 backdrop-blur-sm transition-opacity" onclick="toggleAdminPanel()"></div>

        <!-- Modal Content -->
        <div class="glass-modal relative w-full max-w-3xl rounded-2xl border border-indigo-600 shadow-2xl p-8 transform transition-all scale-100 bg-zinc-800">
            <h2 class="text-2xl font-bold text-indigo-400 mb-6 border-b-2 border-indigo-600 pb-2">
                Project Assignment
            </h2>
            <p class="text-slate-400 mb-6">Assign and configure a new project for Sahil Sharma below.</p>
            <button onclick="toggleAdminPanel()" class="absolute top-4 right-4 text-gray-400 hover:text-white">
                <i data-lucide="x" class="w-5 h-5"></i>
            </button>
            
            <form id="admin-form" onsubmit="event.preventDefault(); submitAdminData();">
                <div class="mb-5">
                    <label for="admin-project-name" class="block text-sm font-medium text-slate-300 mb-1">Project Name / Client</label>
                    <input type="text" id="admin-project-name" required class="mt-1 block w-full rounded-lg border-transparent shadow-sm p-3 bg-slate-700 text-white placeholder-slate-500 focus:ring-indigo-500 focus:border-indigo-500">
                </div>

                <div class="grid grid-cols-1 sm:grid-cols-2 gap-5 mb-5">
                    <div>
                        <label for="admin-bid-amount" class="block text-sm font-medium text-slate-300 mb-1">Target Bid Amount (USD)</label>
                        <input type="number" id="admin-bid-amount" required class="mt-1 block w-full rounded-lg border-transparent shadow-sm p-3 bg-slate-700 text-white placeholder-slate-500 focus:ring-indigo-500 focus:border-indigo-500" min="0">
                    </div>
                    <div>
                        <label for="admin-days-left" class="block text-sm font-medium text-slate-300 mb-1">Bidding/Deadline Days Left</label>
                        <input type="number" id="admin-days-left" required class="mt-1 block w-full rounded-lg border-transparent shadow-sm p-3 bg-slate-700 text-white placeholder-slate-500 focus:ring-indigo-500 focus:border-indigo-500" min="0">
                    </div>
                </div>

                <div class="mb-6">
                    <label for="admin-description" class="block text-sm font-medium text-slate-300 mb-1">Detailed Scope of Work Description</label>
                    <textarea id="admin-description" rows="7" required class="mt-1 block w-full rounded-lg border-transparent shadow-sm p-3 bg-slate-700 text-white placeholder-slate-500 focus:ring-indigo-500 focus:border-indigo-500"></textarea>
                </div>
                
                <button type="submit" class="w-full py-3 px-4 border border-transparent rounded-lg shadow-lg text-white bg-indigo-600 hover:bg-indigo-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-indigo-500 focus:ring-offset-zinc-800 transition duration-150 font-semibold uppercase tracking-wider">
                    Save & Update Dashboard Data
                </button>
            </form>
        </div>
    </div>


<script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
    import { getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
    // Realtime Database Imports
    import { getDatabase, ref, set, onValue, update } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-database.js";

    // --- FIREBASE SETUP ---
    // setLogLevel is for Firestore, not needed for RTDB but keeping for general debug clarity if other Firebase services were used
    // setLogLevel('Debug'); 
    
    // Global Configuration
    const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
    // Sanitize appId for Realtime Database by replacing invalid path characters
    // Invalid chars in RTDB: . # $ [ ] /
    const sanitizedAppId = appId.replace(/[.#$[\]/]/g, '_'); 
    
    const firebaseConfig = JSON.parse(typeof __firebase_config !== 'undefined' ? __firebase_config : '{}');
    const initialAuthToken = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null;
    
    let dbRTDB; // Realtime Database instance
    let auth;
    let userId = null;
    
    // RTDB path: using the sanitized ID
    const DB_PATH = `artifacts/${sanitizedAppId}/public/data/freelancer_dashboard/sahil_sharma_data`;

    // Global State for UI/Interactions
    let dashboardData = {
        projectName: null, // Initial state set to null for "No Project"
        bidAmount: 'N/A',
        endDateISO: null,
        projectDescription: 'Awaiting project brief.',
        proposalId: 'BID-0000-XX',
        deliveryTime: '2 Days',
        status: 'Active' // 'Active' or 'Withdrawn'
    };
    
    let appState = JSON.parse(localStorage.getItem('freelancer_dashboard_state')) || {
        wallet: 0,
        currentBid: { price: 250, status: 'Active', delivery: '2 Days' }
    };

    // --- DOM REFERENCES (Initialized later in initDomReferences) ---
    let bidAmountEl;
    let projectNameDisplayEl;
    let projectDescriptionEl;
    let countdownEl;
    let statusContainer;
    let adminPanelEl;
    let projectCardEl;
    let actionButtonsEl;
    let withdrawnMsgEl;
    let displayProposalIdEl;
    let displayDeliveryTimeEl;
    let activeBidsSection;
    let noProjectPlaceholder;


    function initDomReferences() {
        // Initialize all global DOM variables
        bidAmountEl = document.getElementById('display-price');
        projectNameDisplayEl = document.getElementById('project-name-display');
        projectDescriptionEl = document.getElementById('project-description');
        countdownEl = document.getElementById('countdown');
        statusContainer = document.getElementById('status-container');
        adminPanelEl = document.getElementById('admin-panel');
        projectCardEl = document.getElementById('project-card');
        actionButtonsEl = document.getElementById('action-buttons');
        withdrawnMsgEl = document.getElementById('withdrawn-msg');
        displayProposalIdEl = document.getElementById('display-proposal-id');
        displayDeliveryTimeEl = document.getElementById('display-delivery-time');
        activeBidsSection = document.getElementById('active-bids-section');
        noProjectPlaceholder = document.getElementById('no-project-placeholder');
    }

    // --- FIREBASE INITIALIZATION & AUTH ---
    async function initializeFirebase() {
        if (!firebaseConfig || Object.keys(firebaseConfig).length === 0) {
            Toastify({ text: "Firebase configuration is missing.", duration: 5000, style: { background: "#dc2626" } }).showToast();
            return;
        }

        try {
            const app = initializeApp(firebaseConfig);
            dbRTDB = getDatabase(app); // Initialize Realtime DB
            auth = getAuth(app);

            // Authentication logic
            if (initialAuthToken) {
                await signInWithCustomToken(auth, initialAuthToken);
            } else {
                await signInAnonymously(auth);
            }

            onAuthStateChanged(auth, (user) => {
                if (user) {
                    userId = user.uid;
                    setupDataListener();
                } else {
                    console.log("User signed out or anonymous.");
                }
            });

        } catch (error) {
            console.error("Firebase Initialization Error:", error);
            Toastify({ text: `Failed to initialize Firebase: ${error.message}`, duration: 5000, style: { background: "#dc2626" } }).showToast();
        }
    }

    // --- RTDB DATA LISTENER (Dashboard) ---
    function setupDataListener() {
        if (!dbRTDB) return;

        const dataRef = ref(dbRTDB, DB_PATH);

        // Listen for real-time changes
        onValue(dataRef, (snapshot) => {
            const data = snapshot.val() || {};
            
            // Check for valid project data (must have a project name assigned)
            let hasProjectData = data && data.projectName && data.projectName !== '';
            
            if (hasProjectData) {
                dashboardData = {
                    projectName: data.projectName,
                    bidAmount: data.bidAmount || 0,
                    endDateISO: data.endDateISO || null,
                    projectDescription: data.projectDescription || 'Detailed brief forthcoming.',
                    proposalId: data.proposalId || 'BID-0000-XX',
                    deliveryTime: data.deliveryTime || '2 Days',
                    status: data.status || 'Active'
                };
            } else {
                 dashboardData = {
                    projectName: null, // Force null for no project state
                    bidAmount: 'N/A',
                    endDateISO: null,
                    projectDescription: 'Awaiting project brief.',
                    proposalId: 'BID-0000-XX',
                    deliveryTime: '2 Days',
                    status: 'Active'
                };
            }
            
            updateUIFromFirestore(data);
        }, (error) => {
            console.error("Error listening to dashboard data:", error);
            Toastify({ text: `Connection error. Retrying...`, duration: 3000, style: { background: "#dc2626" } }).showToast();
        });
    }

    // --- UI Update from RTDB Data ---
    function updateUIFromFirestore(data) {
        let hasProjectData = dashboardData.projectName !== null;

        // 1. Toggle Placeholder vs. Project View
        if (activeBidsSection && noProjectPlaceholder) {
            if (hasProjectData) {
                activeBidsSection.classList.remove('hidden');
                noProjectPlaceholder.classList.add('hidden');
            } else {
                activeBidsSection.classList.add('hidden');
                noProjectPlaceholder.classList.remove('hidden');
            }
        }
        
        // 2. Set UI elements based on data
        if (hasProjectData) {
            if(projectNameDisplayEl) projectNameDisplayEl.textContent = dashboardData.projectName;
            if(bidAmountEl) bidAmountEl.textContent = new Intl.NumberFormat('en-US', { style: 'decimal', minimumFractionDigits: 0 }).format(dashboardData.bidAmount);
            if(projectDescriptionEl) projectDescriptionEl.innerHTML = dashboardData.projectDescription.replace(/\n/g, '<br>');
            if(displayProposalIdEl) displayProposalIdEl.textContent = dashboardData.proposalId;
            if(displayDeliveryTimeEl) displayDeliveryTimeEl.textContent = dashboardData.deliveryTime;

            // Update local state for modal pre-filling
            appState.currentBid.price = dashboardData.bidAmount;
            appState.currentBid.delivery = dashboardData.deliveryTime;

            // Check status
            appState.currentBid.status = dashboardData.status;

        } else {
            // Reset UI when no project data exists
            if(projectNameDisplayEl) projectNameDisplayEl.textContent = 'Project TBD';
            if(bidAmountEl) bidAmountEl.textContent = 'N/A';
            if(projectDescriptionEl) projectDescriptionEl.innerHTML = 'Awaiting configuration.';
            if(displayProposalIdEl) displayProposalIdEl.textContent = 'Loading...';
            if(displayDeliveryTimeEl) displayDeliveryTimeEl.textContent = 'N/A';
        }
        
        // 3. Update Admin Form and render general UI
        updateAdminForm();
        render();
    }

    function updateAdminForm() {
        const adminProjectNameInput = document.getElementById('admin-project-name');
        const adminBidAmountInput = document.getElementById('admin-bid-amount');
        const adminDescriptionInput = document.getElementById('admin-description');
        const adminDaysLeftInput = document.getElementById('admin-days-left');

        if (adminPanelEl && !adminPanelEl.classList.contains('hidden')) {
            // Populate form fields with current dashboardData if available, otherwise clear them
            if(adminProjectNameInput) adminProjectNameInput.value = dashboardData.projectName || '';
            if(adminBidAmountInput) adminBidAmountInput.value = dashboardData.bidAmount !== 'N/A' ? dashboardData.bidAmount : '';
            if(adminDescriptionInput) adminDescriptionInput.value = dashboardData.projectDescription !== 'Awaiting project brief.' ? dashboardData.projectDescription : '';

            // Calculate days left from ISO date for the admin input field
            if (dashboardData.endDateISO) {
                const endTime = new Date(dashboardData.endDateISO).getTime();
                const now = new Date().getTime();
                const distance = endTime - now;
                const daysLeft = Math.ceil(distance / (1000 * 60 * 60 * 24));
                if(adminDaysLeftInput) adminDaysLeftInput.value = Math.max(0, daysLeft);
            } else {
                 if(adminDaysLeftInput) adminDaysLeftInput.value = 0;
            }
        }
    }

    // --- RTDB DATA SUBMISSION (Configuration Panel) ---
    window.submitAdminData = async function() {
        if (!dbRTDB) {
            Toastify({ text: "Database not ready.", duration: 3000, style: { background: "#dc2626" } }).showToast();
            return;
        }

        const newProjectName = document.getElementById('admin-project-name').value.trim();
        const newBidAmount = parseFloat(document.getElementById('admin-bid-amount').value);
        const newDaysLeft = parseInt(document.getElementById('admin-days-left').value, 10);
        const newDescription = document.getElementById('admin-description').value;
        
        if (isNaN(newBidAmount) || isNaN(newDaysLeft) || newProjectName === '' || !newDescription) {
            Toastify({ text: "Please fill out all fields correctly.", duration: 3000, style: { background: "#dc2626" } }).showToast();
            return;
        }

        const dataRef = ref(dbRTDB, DB_PATH);
        
        // Calculate End Date ISO from daysLeft
        const endDate = new Date(new Date().getTime() + (newDaysLeft * 24 * 60 * 60 * 1000));
        
        // Use existing Proposal ID, or initialize a new random one on first setup
        const proposalId = dashboardData.proposalId === 'BID-0000-XX' || dashboardData.projectName === null 
                           ? `BID-${Math.random().toString(36).substring(2, 10).toUpperCase()}` 
                           : dashboardData.proposalId;
        
        // Use existing delivery time or default
        const deliveryTime = dashboardData.deliveryTime || '7 Days';

        const newProjectData = {
            projectName: newProjectName,
            bidAmount: newBidAmount,
            endDateISO: endDate.toISOString(),
            projectDescription: newDescription,
            proposalId: proposalId, 
            deliveryTime: deliveryTime, 
            status: 'Active', // Always set to Active on admin submit
            lastUpdated: new Date().toISOString()
        };

        try {
            // Using set() to overwrite or create the main project document
            await set(dataRef, newProjectData);
            toggleAdminPanel(); // Close panel on success
            Toastify({ text: "Dashboard data has been updated and saved successfully.", duration: 3000, style: { background: "#10b981" } }).showToast();
        } catch (error) {
            console.error("Error writing document: ", error);
            Toastify({ text: `Failed to update data: ${error.message}`, duration: 5000, style: { background: "#dc2626" } }).showToast();
        }
    }
    
    // --- UI/LOCAL STORAGE FUNCTIONS (From User Template - Adapted) ---

    function saveState() {
        localStorage.setItem('freelancer_dashboard_state', JSON.stringify(appState));
    }

    function render() {
        // 1. Wallet (All locations)
        const formattedWallet = appState.wallet.toLocaleString();
        ['sidebar-wallet-amount', 'header-wallet-amount', 'drawer-wallet-amount'].forEach(id => {
            const el = document.getElementById(id);
            if (el) el.textContent = formattedWallet;
        });

        // 2. Bid Price
        if(bidAmountEl) bidAmountEl.textContent = dashboardData.bidAmount !== 'N/A' ? new Intl.NumberFormat('en-US', { style: 'decimal', minimumFractionDigits: 0 }).format(dashboardData.bidAmount) : 'N/A';
        const editPriceInput = document.getElementById('edit-price-input');
        if(editPriceInput) editPriceInput.value = appState.currentBid.price !== 'N/A' ? appState.currentBid.price : 0;
        
        // 3. Bid Status - Added null checks
        if (statusContainer && projectCardEl && actionButtonsEl && withdrawnMsgEl) {
            if (dashboardData.status === 'Active' && dashboardData.projectName !== null) {
                statusContainer.innerHTML = `
                    <span class="relative flex h-3 w-3 mr-2">
                        <span class="animate-ping absolute inline-flex h-full w-full rounded-full bg-blue-400 opacity-75"></span>
                        <span class="relative inline-flex rounded-full h-3 w-3 bg-blue-500"></span>
                    </span>
                    <p class="text-white font-medium">Active & Viewed</p>
                `;
                projectCardEl.classList.remove('border-red-500/30');
                projectCardEl.classList.add('border-blue-500/30');
                actionButtonsEl.classList.remove('hidden');
                actionButtonsEl.classList.add('flex');
                withdrawnMsgEl.classList.add('hidden');
            } else if (dashboardData.status === 'Withdrawn') {
                statusContainer.innerHTML = `
                    <div class="w-3 h-3 rounded-full bg-red-500 mr-2"></div>
                    <p class="text-red-400 font-medium">Withdrawn</p>
                `;
                projectCardEl.classList.remove('border-blue-500/30');
                projectCardEl.classList.add('border-red-500/30');
                actionButtonsEl.classList.add('hidden');
                actionButtonsEl.classList.remove('flex');
                withdrawnMsgEl.classList.remove('hidden');
            } else {
                 statusContainer.innerHTML = `<p class="text-gray-500 font-medium">Awaiting Data</p>`;
            }
        }
    }

    // 1. Mobile Menu Logic
    window.toggleMobileMenu = function() {
        const menu = document.getElementById('mobile-menu');
        if (menu) {
            if (menu.classList.contains('hidden')) {
                menu.classList.remove('hidden');
            } else {
                menu.classList.add('hidden');
            }
        }
    }

    // 2. Wallet Logic
    window.addFunds = function() {
        const amount = 100; 
        appState.wallet += amount;
        saveState();
        render();
        
        Toastify({
            text: `Success! Added $${amount} to wallet.`,
            duration: 3000,
            gravity: "top", 
            position: "center",
            style: { background: "#059669", borderRadius: "12px" },
        }).showToast();
    }

    // 3. Edit Modal Logic
    window.openEditModal = function() {
        if (dashboardData.status !== 'Active' || dashboardData.projectName === null) {
            Toastify({ text: "Cannot edit: No active proposal.", duration: 3000, style: { background: "#dc2626" } }).showToast();
            return;
        }
        const editModal = document.getElementById('edit-modal');
        const editPriceInput = document.getElementById('edit-price-input');
        const editDeliveryTimeSelect = document.getElementById('edit-delivery-time');

        if (editModal) {
            editModal.classList.remove('hidden');
            editModal.classList.add('flex');
            if(editPriceInput) editPriceInput.value = dashboardData.bidAmount;
            if(editDeliveryTimeSelect) editDeliveryTimeSelect.value = dashboardData.deliveryTime;
        }
    }

    window.closeEditModal = function() {
        const editModal = document.getElementById('edit-modal');
        if (editModal) {
            editModal.classList.add('hidden');
            editModal.classList.remove('flex');
        }
    }

    window.saveProposal = async function() {
        if (!dbRTDB) {
            Toastify({ text: "Database not ready.", duration: 3000, style: { background: "#dc2626" } }).showToast();
            return;
        }
        
        const newPrice = parseInt(document.getElementById('edit-price-input').value);
        const newDelivery = document.getElementById('edit-delivery-time').value;
        
        if (newPrice < 5 || isNaN(newPrice)) {
            Toastify({ text: "Minimum valid bid is $5.", duration: 3000, style: { background: "#dc2626" } }).showToast();
            return;
        }
        
        const dataRef = ref(dbRTDB, DB_PATH);
        try {
            // Using update() for a partial change in RTDB
            await update(dataRef, { bidAmount: newPrice, deliveryTime: newDelivery, lastUpdated: new Date().toISOString() });
            closeEditModal();
            Toastify({ text: "Proposal updated successfully!", duration: 3000, gravity: "top", position: "center", style: { background: "#2563eb", borderRadius: "12px" } }).showToast();
        } catch(error) {
             Toastify({ text: `Failed to save changes: ${error.message}`, duration: 5000, style: { background: "#dc2626" } }).showToast();
        }
    }

    // 4. Withdraw Logic
    window.withdrawBid = async function() {
        if (!dbRTDB) {
            Toastify({ text: "Database not ready.", duration: 3000, style: { background: "#dc2626" } }).showToast();
            return;
        }

        if (dashboardData.status !== 'Active' || dashboardData.projectName === null) {
             Toastify({ text: "No active proposal to withdraw.", duration: 3000, style: { background: "#dc2626" } }).showToast();
             return;
        }
        
        const dataRef = ref(dbRTDB, DB_PATH);
        try {
            // Using update() to change only the status field in RTDB
            await update(dataRef, { status: 'Withdrawn', lastUpdated: new Date().toISOString() });
            Toastify({ text: "Bid successfully withdrawn.", duration: 3000, gravity: "top", position: "center", style: { background: "#dc2626", borderRadius: "12px" } }).showToast();
        } catch (error) {
            Toastify({ text: `Failed to withdraw bid: ${error.message}`, duration: 5000, style: { background: "#dc2626" } }).showToast();
        }
    }

    // 5. Navigation Logic
    window.switchTab = function(tabName) {
        const buttons = ['dashboard', 'browse', 'messages', 'finances'];
        buttons.forEach(btn => {
            const el = document.getElementById(`nav-${btn}`);
            const mobEl = document.getElementById(`mobile-nav-${btn}`);
            
            const action = (el, isActive) => {
                if(el) {
                    el.classList.toggle('bg-blue-600/10', isActive);
                    el.classList.toggle('text-blue-400', isActive);
                    el.classList.toggle('text-gray-400', !isActive);
                    el.classList.toggle('hover:bg-slate-800', !isActive);
                }
            };
            action(el, btn === tabName);
            action(mobEl, btn === tabName);
        });

        const dashView = document.getElementById('view-dashboard');
        const placeView = document.getElementById('view-placeholder');
        const placeTitle = document.getElementById('placeholder-title');
        const placeIcon = document.getElementById('placeholder-icon');

        if(dashView && placeView) {
            if(tabName === 'dashboard') {
                dashView.classList.remove('hidden');
                placeView.classList.add('hidden');
            } else {
                dashView.classList.add('hidden');
                placeView.classList.remove('hidden');
                placeView.classList.add('flex');
                
                const titles = { 'browse': 'Browse Projects', 'messages': 'Messages', 'finances': 'Financial Overview' };
                const icons = { 'browse': 'search', 'messages': 'message-square', 'finances': 'credit-card' }
                
                if(placeTitle) placeTitle.textContent = titles[tabName];
                if(placeIcon) placeIcon.setAttribute('data-lucide', icons[tabName]);
                lucide.createIcons();
            }
        }
    }


    // --- TIMING LOGIC ---
    function updateGreeting() {
        const hour = new Date().getHours();
        const greetingElement = document.getElementById('greeting-text');
        let greeting;
        if (hour >= 5 && hour < 12) greeting = "Good Morning";
        else if (hour >= 12 && hour < 18) greeting = "Good Afternoon";
        else greeting = "Good Evening";
        if(greetingElement) greetingElement.textContent = greeting;
    }

    // Runs every second to update the live countdown based on RTDB's endDateISO
    function startCountdown() {
        setInterval(() => {
            if (!countdownEl) return;
            
            const timerContainer = document.getElementById('timer-container');

            if (dashboardData.endDateISO && dashboardData.status === 'Active') {
                const endTime = new Date(dashboardData.endDateISO).getTime();
                const currentTime = new Date().getTime();
                const distance = endTime - currentTime;

                if (distance < 0) {
                    countdownEl.textContent = "BIDDING CLOSED";
                    if(timerContainer) timerContainer.classList.remove('animate-glow-pulse');
                    return;
                }

                const days = Math.floor(distance / (1000 * 60 * 60 * 24));
                const hours = Math.floor((distance % (1000 * 60 * 60 * 24)) / (1000 * 60 * 60));
                const minutes = Math.floor((distance % (1000 * 60 * 60)) / (1000 * 60));
                const seconds = Math.floor((distance % (1000 * 60)) / 1000);

                countdownEl.textContent = `Ends in ${days}d ${hours}h ${minutes}m ${seconds}s`;
            } else if (dashboardData.status === 'Withdrawn') {
                countdownEl.textContent = "---";
                if(timerContainer) timerContainer.classList.remove('animate-glow-pulse');
            } else {
                 countdownEl.textContent = "Date TBD";
                 if(timerContainer) timerContainer.classList.remove('animate-glow-pulse');
            }
        }, 1000);
    }

    // --- HIDDEN CONFIGURATION PANEL LOGIC (Ctrl + Alt + U) ---
    function checkSecretKey(event) {
        if (event.ctrlKey && event.altKey && event.key === 'U') {
            event.preventDefault(); 
            toggleAdminPanel();
        }
    }

    window.toggleAdminPanel = function() {
        if (!adminPanelEl) return;
        const isHidden = adminPanelEl.classList.contains('hidden');

        if (isHidden) {
            adminPanelEl.classList.remove('hidden');
            adminPanelEl.classList.add('flex');
            updateAdminForm();
            lucide.createIcons();
        } else {
            adminPanelEl.classList.add('hidden');
            adminPanelEl.classList.remove('flex');
        }
    }

    // --- INIT ---
    document.addEventListener('DOMContentLoaded', () => {
        initDomReferences();
        lucide.createIcons();
        updateGreeting();
        startCountdown();
        initializeFirebase();
    });

    document.addEventListener('keydown', checkSecretKey);

</script>
</body>
</html>
